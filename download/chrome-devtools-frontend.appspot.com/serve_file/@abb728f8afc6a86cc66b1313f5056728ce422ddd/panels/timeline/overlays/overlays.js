import*as e from"../../../core/platform/platform.js";import*as t from"../../../models/trace/trace.js";import*as n from"./components/components.js";const i=t.Types.Timing.MicroSeconds(5e3);function s(e){return"CURSOR_TIMESTAMP_MARKER"===e.type||"ENTRY_SELECTED"===e.type}class r extends Event{overlay;action;static eventName="annotationoverlayactionsevent";constructor(e,t){super(r.eventName),this.overlay=e,this.action=t}}class o extends EventTarget{#e=new Map;#t=null;#n=null;#i;#s={trace:{visibleWindow:null},charts:{main:null,network:null}};#r;#o;#a;constructor(e){super(),this.#o=e.container,this.#a=e.flameChartsContainer,this.#r=e.charts,this.#i=null,this.#a.addEventListener("mousemove",this.#l.bind(this))}#l(e){const t=e;if(this.#t=t.offsetX,this.#n=t.offsetY,!this.#i||this.#i.entryTo)return;const n=this.#s.charts.network?.heightPixels??0,i=this.#e.get(this.#i);if(i){i.querySelector("devtools-entries-link-overlay").coordinateTo={x:t.offsetX,y:t.offsetY+n}}}timingsForOverlayEntry(e){if(e instanceof t.Handlers.ModelHandlers.Frames.TimelineFrame)return{startTime:e.startTime,endTime:e.endTime,duration:e.duration};if(t.Types.TraceEvents.isSyntheticLayoutShift(e)){return{endTime:t.Types.Timing.MicroSeconds(e.ts+i),duration:i,startTime:e.ts}}return t.Helpers.Timing.eventTimingsMicroSeconds(e)}#h(e){return e instanceof t.Handlers.ModelHandlers.Frames.TimelineFrame?"main":t.Types.TraceEvents.isNetworkTrackEntry(e)?"network":"main"}add(e){if(this.#e.has(e))return e;const t=this.overlaysOfType(e.type);return s(e)&&t[0]?(this.updateExisting(t[0],e),t[0]):(this.#e.set(e,null),e)}updateExisting(e,t){if(this.#e.has(e))for(const[n,i]of Object.entries(t)){e[n]=i}else console.error("Trying to update an overlay that does not exist.")}overlaysForEntry(e){const t=[];for(const[n]of this.#e)"entry"in n&&n.entry===e&&t.push(n);return t}removeOverlaysOfType(e){const t=Array.from(this.#e.keys()).filter((t=>t.type===e));for(const e of t)this.remove(e);return t.length}overlaysOfType(e){const t=[];function n(t){return t.type===e}for(const[e]of this.#e)n(e)&&t.push(e);return t}remove(e){const t=this.#e.get(e);t&&this.#o&&this.#o.removeChild(t),this.#e.delete(e)}updateChartDimensions(e,t){this.#s.charts[e]=t}updateVisibleWindow(e){this.#s.trace.visibleWindow=e}reset(){this.#o&&(this.#o.innerHTML=""),this.#e.clear(),this.#s.trace.visibleWindow=null,this.#s.charts.main=null,this.#s.charts.network=null}update(){const e=[];for(const[t,n]of this.#e){const i=n||this.#c(t);n?this.#y(t,i):(this.#e.set(t,i),this.#o.appendChild(i)),this.#d(t,i),"TIME_RANGE"===t.type&&e.push(t)}e.length>1&&this.#m(e)}#m(e){const n=e.toSorted(((e,t)=>e.bounds.min-t.bounds.min)),i=new Map;for(let e=0;e<n.length;e++){const s=n[e],r=[];for(let i=e+1;i<n.length;i++){const e=n[i];if(!t.Helpers.Timing.boundsIncludeTimeRange({bounds:s.bounds,timeRange:e.bounds}))break;r.push(e)}i.set(s,r)}for(const[e,t]of i){const n=this.#e.get(e);if(!n)continue;let i=1;n.getAttribute("class")?.includes("overlap-")&&(i=0),t.forEach((e=>{const t=this.#e.get(e);t?.classList.add("overlap-"+i++)}))}}#d(n,i){switch(n.type){case"ENTRY_SELECTED":this.entryIsVisibleOnChart(n.entry)?(i.style.visibility="visible",this.#v(n,i)):i.style.visibility="hidden";break;case"ENTRY_OUTLINE":{const e=this.overlaysOfType("ENTRY_SELECTED")?.at(0);!Boolean(e&&e.entry===n.entry)&&this.entryIsVisibleOnChart(n.entry)?(i.style.visibility="visible",this.#v(n,i)):i.style.visibility="hidden";break}case"TIME_RANGE":{this.#u(n,i);const e=i.querySelector("devtools-time-range-overlay");e&&e.afterOverlayUpdate();break}case"ENTRY_LABEL":if(this.entryIsVisibleOnChart(n.entry)){i.style.visibility="visible";const e=this.#E(n,i),t=i.querySelector("devtools-entry-label-overlay");t&&e?t.entryLabelParams=e:(i.style.visibility="hidden",console.error("Cannot calculate entry width and height values required to draw a label overlay."))}else i.style.visibility="hidden";break;case"ENTRIES_LINK":this.#p(n,i);break;case"TIMESPAN_BREAKDOWN":{this.#f(n,i);const e=i.querySelector("devtools-timespan-breakdown-overlay");if(e&&e.afterOverlayUpdate(),n.entry){const{visibleWindow:e}=this.#s.trace;e&&this.#T(n.entry)&&t.Helpers.Timing.boundsIncludeTimeRange({bounds:e,timeRange:n.sections[0].bounds})?i.style.visibility="visible":i.style.visibility="hidden"}break}case"CURSOR_TIMESTAMP_MARKER":{const{visibleWindow:e}=this.#s.trace;e&&t.Helpers.Timing.timestampIsInBounds(e,n.timestamp)?(i.style.visibility="visible",this.#O(n,i)):i.style.visibility="hidden";break}case"CANDY_STRIPED_TIME_RANGE":{const{visibleWindow:e}=this.#s.trace;e&&this.#T(n.entry)&&t.Helpers.Timing.boundsIncludeTimeRange({bounds:e,timeRange:n.bounds})?(i.style.visibility="visible",this.#x(n,i)):i.style.visibility="hidden";break}default:e.TypeScriptUtilities.assertNever(n,`Unknown overlay: ${JSON.stringify(n)}`)}}#O(e,t){const n=this.#b("main",e.timestamp);t.style.left=`${n}px`}#f(e,t){const n=t.querySelector("devtools-timespan-breakdown-overlay"),i=n?.shadowRoot,s=i?.querySelectorAll(".timespan-breakdown-overlay-section");if(0===e.sections.length)return;const r=this.#b("main",e.sections[0].bounds.min),o=this.#b("main",e.sections[e.sections.length-1].bounds.max);if(null===r||null===o)return;const a=o-r;if(t.style.left=`${r}px`,t.style.width=`${a}px`,!s?.length)return;let l=0;for(const t of e.sections){const e=this.#b("main",t.bounds.min),n=this.#b("main",t.bounds.max);if(null===e||null===n)return;const i=n-e,r=s[l];r.style.left=`${e}px`,r.style.width=`${i}px`,l++}if(e.entry){if("network"===this.#h(e.entry)){const n=this.yPixelForEventOnChart(e.entry);if(null===n)return;const i=50,r=n-7,o=Math.max(r,0),a=Math.min(i,o);s[0].style.maxHeight=`${i}px`,s[0].style.height=`${a}px`;const l=r-a;t.style.top=`${l}px`,t.style.fontStyle="italic";const h=s[0].querySelector(".timespan-breakdown-overlay-label"),c=h?.querySelector("span");c&&h?.removeChild(c)}}}#p(e,t){const n=this.xPixelForEventEndOnChart(e.entryFrom)??0,i=(this.pixelHeightForEventOnChart(e.entryFrom)??0)/2,s=(this.yPixelForEventOnChart(e.entryFrom)??0)+i,r=t.querySelector("devtools-entries-link-overlay");r&&(r.coordinateFrom={x:n,y:s})}#u(e,t){const n=this.#b("main",e.bounds.min),i=this.#b("main",e.bounds.max);if(null===n||null===i)return;const s=i-n;t.style.left=`${n}px`,t.style.width=`${s}px`}#E(e,t){const i=this.#h(e.entry),s=this.xPixelForEventStartOnChart(e.entry),r=this.yPixelForEventOnChart(e.entry),{endTime:o}=this.timingsForOverlayEntry(e.entry),a=this.#b(i,o),l=this.pixelHeightForEventOnChart(e.entry)??0;if(null===s||null===r||null===a)return null;const h=a-s,c=Math.max(2,h),y=this.#s.charts.network?.heightPixels??0,d=this.networkChartOffsetHeight()-r,m=l+r-y,v=Math.max("main"===i?d:m,0);let u=r-n.EntryLabelOverlay.EntryLabelOverlay.LABEL_AND_CONNECTOR_HEIGHT;return"main"===i&&(u+=v),t.style.top=`${u}px`,t.style.left=`${s+c/2}px`,{height:l,width:c,cutOffEntryHeight:v,chart:i}}#x(e,t){const n=this.#h(e.entry),i=this.#b(n,e.bounds.min),s=this.#b(n,e.bounds.max);if(null===i||null===s)return;const r=s-i,o=Math.max(2,r);t.style.width=`${o}px`,t.style.left=`${i}px`;let a=this.yPixelForEventOnChart(e.entry);if(null===a)return;const l=this.pixelHeightForEventOnChart(e.entry)??0;let h=l;if(null!==h){if("main"===n){const e=this.networkChartOffsetHeight(),n=a<e;h=n?Math.abs(a+h-e):h,t.classList.toggle("cut-off-top",n),n&&(a=a+l-h)}else{const e=this.#s.charts.network?.heightPixels??0,n=a+l>e,i=a>e;t.classList.toggle("cut-off-top",i),t.classList.toggle("cut-off-bottom",n),n&&(h=e-a)}t.style.height=`${h}px`,t.style.top=`${a}px`}}#v(e,t){const n=this.#h(e.entry);let i=this.xPixelForEventStartOnChart(e.entry),s=this.yPixelForEventOnChart(e.entry);if(null===i||null===s)return;const{endTime:r,duration:o}=this.timingsForOverlayEntry(e.entry),a=this.#b(n,r);if(null===a)return;const l=this.pixelHeightForEventOnChart(e.entry)??0;let h=l;if(null===h)return;let c=a-i;if(!o){const t="main"===n?this.#r.mainProvider:this.#r.networkProvider,s="main"===n?this.#r.mainChart:this.#r.networkChart,r=t.indexForEvent?.(e.entry),o=s.getMarkerPixelsForEntryIndex(r??-1);o&&(i=o.x,c=o.width)}const y=Math.max(2,c);if(t.style.width=`${y}px`,"main"===n){const e=this.networkChartOffsetHeight(),n=s<e;h=n?Math.abs(s+h-e):h,t.classList.toggle("cut-off-top",n),n&&(s=s+l-h)}else{const e=this.#s.charts.network?.heightPixels??0,n=s+l>e;t.classList.toggle("cut-off-bottom",n),n&&(h=e-s)}t.style.height=`${h}px`,t.style.top=`${s}px`,t.style.left=`${i}px`}#c(e){const t=document.createElement("div");switch(t.classList.add("overlay-item",`overlay-type-${e.type}`),e.type){case"ENTRY_LABEL":{const i=new n.EntryLabelOverlay.EntryLabelOverlay(e.label,"main"===this.#h(e.entry));return i.addEventListener(n.EntryLabelOverlay.EmptyEntryLabelRemoveEvent.eventName,(()=>{this.dispatchEvent(new r(e,"Remove"))})),i.addEventListener(n.EntryLabelOverlay.EntryLabelChangeEvent.eventName,(t=>{const n=t.newLabel;e.label=n,this.dispatchEvent(new r(e,"Update"))})),t.appendChild(i),t}case"ENTRIES_LINK":{const i=this.xPixelForEventEndOnChart(e.entryFrom)??0,s=(this.pixelHeightForEventOnChart(e.entryFrom)??0)/2,r=(this.yPixelForEventOnChart(e.entryFrom)??0)+s,o=new n.EntriesLinkOverlay.EntriesLinkOverlay({x:i,y:r});return t.appendChild(o),t}case"ENTRY_OUTLINE":return t.classList.add(`outline-reason-${e.outlineReason}`),t;case"TIME_RANGE":{const i=new n.TimeRangeOverlay.TimeRangeOverlay(e.label);return i.duration=e.showDuration?e.bounds.range:null,i.canvasRect=this.#r.mainChart.canvasBoundingClientRect(),i.addEventListener(n.TimeRangeOverlay.TimeRangeLabelChangeEvent.eventName,(t=>{const n=t.newLabel;e.label=n,this.dispatchEvent(new r(e,"Update"))})),i.addEventListener(n.TimeRangeOverlay.TimeRangeRemoveEvent.eventName,(()=>{this.dispatchEvent(new r(e,"Remove"))})),t.appendChild(i),t}case"TIMESPAN_BREAKDOWN":{const i=new n.TimespanBreakdownOverlay.TimespanBreakdownOverlay;return i.sections=e.sections,i.canvasRect=this.#r.mainChart.canvasBoundingClientRect(),t.appendChild(i),t}default:return t}}#y(t,n){switch(t.type){case"ENTRY_SELECTED":case"ENTRY_OUTLINE":case"ENTRY_LABEL":case"CURSOR_TIMESTAMP_MARKER":case"CANDY_STRIPED_TIME_RANGE":break;case"TIME_RANGE":{const e=n.querySelector("devtools-time-range-overlay");e&&(e.duration=t.showDuration?t.bounds.range:null,e.canvasRect=this.#r.mainChart.canvasBoundingClientRect());break}case"ENTRIES_LINK":{const e=n.querySelector("devtools-entries-link-overlay");if(e)if(t.entryTo){const n=this.xPixelForEventStartOnChart(t.entryTo)??0,i=(this.pixelHeightForEventOnChart(t.entryTo)??0)/2,s=(this.yPixelForEventOnChart(t.entryTo)??0)+i;e.coordinateTo={x:n,y:s}}else this.#t&&this.#n&&(this.#i=t);break}case"TIMESPAN_BREAKDOWN":{const e=n.querySelector("devtools-timespan-breakdown-overlay");e&&(e.sections=t.sections,e.canvasRect=this.#r.mainChart.canvasBoundingClientRect());break}default:e.TypeScriptUtilities.assertNever(t,`Unexpected overlay ${t}`)}}entryIsVisibleOnChart(e){const t=this.#T(e),n=this.#g(e);return t&&n}#g(e){if(null===this.#s.trace.visibleWindow)return!1;const{startTime:n,endTime:i}=this.timingsForOverlayEntry(e),s=t.Helpers.Timing.traceWindowFromMicroSeconds(n,i);return t.Helpers.Timing.boundsIncludeTimeRange({bounds:this.#s.trace.visibleWindow,timeRange:s})}#T(e){const t=this.#h(e),n=this.yPixelForEventOnChart(e);if(null===n)return!1;const i=this.pixelHeightForEventOnChart(e);if(!i)return!1;if("main"===t){if(!this.#s.charts.main?.heightPixels)return!1;const e=n-this.networkChartOffsetHeight();if(e+i<0)return!1;if(e>this.#s.charts.main.heightPixels)return!1}if("network"===t){if(!this.#s.charts.network)return!1;if(n<=-14)return!1;if(n>this.#s.charts.network.heightPixels)return!1}return!0}xPixelForEventStartOnChart(e){const t=this.#h(e),{startTime:n}=this.timingsForOverlayEntry(e);return this.#b(t,n)}xPixelForEventEndOnChart(e){const t=this.#h(e),{endTime:n}=this.timingsForOverlayEntry(e);return this.#b(t,n)}#b(e,t){if(null===this.#s.trace.visibleWindow)return console.error("Cannot calculate xPixel without visible trace window."),null;const n=this.#s.charts[e]?.widthPixels??null;if(null===n)return console.error(`Cannot calculate xPixel without ${e} dimensions.`),null;const i=t-this.#s.trace.visibleWindow.min,s=this.#s.trace.visibleWindow.range;return Math.floor(i/s*n)}yPixelForEventOnChart(e){const t=this.#h(e),n="main"===t?this.#r.mainChart:this.#r.networkChart,i="main"===t?this.#r.mainProvider:this.#r.networkProvider,s=i.indexForEvent?.(e);if("number"!=typeof s)return null;const r=i.timelineData();if(null===r)return null;const o=r.entryLevels.at(s);if(void 0===o)return null;if(!n.levelIsVisible(o))return null;let a=n.levelToOffset(o)-(this.#s.charts[t]?.scrollOffsetPixels??0);return"main"===t&&(a+=this.networkChartOffsetHeight()),a}pixelHeightForEventOnChart(e){const t=this.#h(e),n="main"===t?this.#r.mainChart:this.#r.networkChart,i="main"===t?this.#r.mainProvider:this.#r.networkProvider,s=i.indexForEvent?.(e);if("number"!=typeof s)return null;const r=i.timelineData();if(null===r)return null;const o=r.entryLevels.at(s);return void 0===o?null:n.levelHeight(o)}networkChartOffsetHeight(){return null===this.#s.charts.network||0===this.#s.charts.network.heightPixels?0:this.#s.charts.network.allGroupsCollapsed?this.#s.charts.network.heightPixels:this.#s.charts.network.heightPixels+8}}var a=Object.freeze({__proto__:null,LAYOUT_SHIFT_SYNTHETIC_DURATION:i,isTimeRangeLabel:function(e){return"TIME_RANGE"===e.type},isEntriesLink:function(e){return"ENTRIES_LINK"===e.type},overlayIsSingleton:s,AnnotationOverlayActionEvent:r,Overlays:o});export{a as Overlays};
