import*as t from"../../../core/platform/platform.js";import*as e from"../../../core/common/common.js";import*as n from"../types/types.js";const r=[],i=new Map;let s=null;class o{#t=[];#e=[];static initAndActivate(t){const e=i.get(t);if(e)s=e;else{const e=new o(t);i.set(t,e),s=e}return s}static getActiveManager(){if(!s)throw new Error("Attempted to get a SyntheticEventsManager without initializing");return s}static reset(){r.length=0,s=null}static registerSyntheticBasedEvent(t){try{return o.getActiveManager().registerSyntheticBasedEvent(t)}catch(e){return t}}static registerServerTiming(t){return t}constructor(t){this.#e=t}registerSyntheticBasedEvent(t){const e=this.#e.indexOf(t.rawSourceEvent);if(e<0)throw new Error("Attempted to register a synthetic event paired to an unknown raw event.");const n=t;return this.#t[e]=n,n}syntheticEventForRawEventIndex(t){const e=this.#t.at(t);if(!e)throw new Error(`Attempted to get a synthetic event from an unknown raw event index: ${t}`);return e}getSyntheticTraceEvents(){return this.#t}getRawTraceEvents(){return this.#e}}var a=Object.freeze({__proto__:null,SyntheticEventsManager:o});const c=t=>n.Timing.MicroSeconds(1e3*t),l=t=>n.Timing.MilliSeconds(1e3*t),u=t=>n.Timing.MilliSeconds(t/1e3),d=t=>n.Timing.Seconds(t/1e3/1e3);function m(t){return{startTime:t.ts,endTime:n.Timing.MicroSeconds(t.ts+(t.dur||n.Timing.MicroSeconds(0))),duration:n.Timing.MicroSeconds(t.dur||0)}}var h=Object.freeze({__proto__:null,millisecondsToMicroseconds:c,secondsToMilliseconds:l,secondsToMicroseconds:t=>c(l(t)),microSecondsToMilliseconds:u,microSecondsToSeconds:d,timeStampForEventAdjustedByClosestNavigation:function(t,e,r,i){let s=t.ts-e.min;if(t.args?.data?.navigationId){const e=r.get(t.args.data.navigationId);e&&(s=t.ts-e.ts)}else if(t.args?.data?.frame){const e=v(t,t.args.data.frame,i);e&&(s=t.ts-e.ts)}return n.Timing.MicroSeconds(s)},eventTimingsMicroSeconds:m,eventTimingsMilliSeconds:function(t){const e=m(t);return{startTime:u(e.startTime),endTime:u(e.endTime),duration:u(e.duration)}},eventTimingsSeconds:function(t){const e=m(t);return{startTime:d(e.startTime),endTime:d(e.endTime),duration:d(e.duration)}},traceWindowMilliSeconds:function(t){return{min:u(t.min),max:u(t.max),range:u(t.range)}},traceWindowMillisecondsToMicroSeconds:function(t){return{min:c(t.min),max:c(t.max),range:c(t.range)}},traceWindowFromMilliSeconds:function(t,e){return{min:c(t),max:c(e),range:n.Timing.MicroSeconds(c(e)-c(t))}},traceWindowFromMicroSeconds:function(t,e){return{min:t,max:e,range:n.Timing.MicroSeconds(e-t)}},boundsIncludeTimeRange:function(t){const{min:e,max:n}=t.bounds,{min:r,max:i}=t.timeRange;return e<=i&&n>=r},timestampIsInBounds:function(t,e){return e>=t.min&&e<=t.max}});function f(t){return t.args?.data?.stackTrace?t.args.data.stackTrace:t.args?.stackTrace?t.args.stackTrace:n.TraceEvents.isTraceEventUpdateLayoutTree(t)?t.args.beginData?.stackTrace||null:n.Extensions.isSyntheticExtensionEntry(t)||n.TraceEvents.isSyntheticUserTiming(t)?f(t.rawSourceEvent):null}function g(t,e){const n=t.ts,r=e.ts;if(n<r)return-1;if(n>r)return 1;const i=n+(t.dur??0),s=r+(e.dur??0);return i>s?-1:i<s?1:0}function p(t){t.sort(g)}function S(t,e){const n=[];let r=0,i=0;for(;r<t.length&&i<e.length;){const s=t[r],o=e[i],a=g(s,o);a<=0&&(n.push(s),r++),1===a&&(n.push(o),i++)}for(;r<t.length;)n.push(t[r++]);for(;i<e.length;)n.push(e[i++]);return n}function v(e,n,r){const i=r.get(n);if(!i||""===n)return null;const s=t.ArrayUtilities.nearestIndexFromEnd(i,(t=>t.ts<=e.ts));return null===s?null:i[s]}function T(t){return t.id??t.id2?.global??t.id2?.local}function E(t,e,r,i,s,o){return{cat:"",name:"ProfileCall",nodeId:t.id,args:{},ph:"X",pid:s,tid:o,ts:i,dur:n.Timing.MicroSeconds(0),callFrame:t.callFrame,sampleIndex:r,profileId:e}}function k(e){const n=new Map;for(const r of e){const e=y(r);if(void 0===e)continue;const i=t.MapUtilities.getWithDefault(n,e,(()=>({begin:null,end:null,instant:[]}))),s="b"===r.ph,o="e"===r.ph,a="n"===r.ph;s?i.begin=r:o?i.end=r:a&&(i.instant||(i.instant=[]),i.instant.push(r))}return n}function y(t){const e=T(t);return e&&`${t.cat}:${e}:${t.name}`}function M(t,e){const r=[];for(const[s,a]of t.entries()){const c=a.begin,l=a.end,u=a.instant;if(!c||!l&&!u)continue;const d={beginEvent:c,endEvent:l,instantEvents:u};function i(t){const e=!!t.instantEvents&&t.instantEvents.some((t=>s===y(t))),n=!!t.endEvent&&s===y(t.endEvent);return Boolean(s)&&(e||n)}if(!i(d))continue;const m=l||c,h=o.registerSyntheticBasedEvent({rawSourceEvent:c,cat:m.cat,ph:m.ph,pid:m.pid,tid:m.tid,id:s,name:c.name,dur:n.Timing.MicroSeconds(m.ts-c.ts),ts:c.ts,args:{data:d}});h.dur<0||(e?.(h),r.push(h))}return r.sort(((t,e)=>t.ts-e.ts))}function b(t){const e={...t};return e.lineNumber=t.lineNumber&&t.lineNumber-1,e.columnNumber=t.columnNumber&&t.columnNumber-1,e}const I="disabled-by-default-devtools.timeline";function w(t){return"JSRoot"===t.name&&"toplevel"===t.cat||t.cat.includes(I)&&"RunTask"===t.name}function N(e,n){let r=t.ArrayUtilities.upperBound(e,n,((t,e)=>t-e.ts))-1;for(;r>0&&!w(e[r]);)r--;return Math.max(r,0)}const x=new Map;var J=Object.freeze({__proto__:null,extractOriginFromTrace:function(t){const n=e.ParsedURL.ParsedURL.fromString(t);return n?n.host.startsWith("www.")?n.host.slice(4):n.host:null},addEventToProcessThread:function(t,e){const{tid:n,pid:r}=t;let i=e.get(r);i||(i=new Map);let s=i.get(n);s||(s=[]),s.push(t),i.set(t.tid,s),e.set(t.pid,i)},eventTimeComparator:g,sortTraceEventsInPlace:p,mergeEventsInOrder:S,getNavigationForTraceEvent:v,extractId:T,activeURLForFrameAtTime:function(t,e,n){const r=n.get(t);if(!r)return null;for(const t of r.values())for(const n of t)if(!(n.window.min>e||n.window.max<e))return n.frame.url;return null},makeProfileCall:E,matchEvents:k,createSortedSyntheticEvents:M,createMatchedSortedSyntheticEvents:function(t,e){return M(k(t),e)},getZeroIndexedLineAndColumnForEvent:function(t){const e=function(t){if(!t.args?.data)return{lineNumber:void 0,columnNumber:void 0};let e,n;"lineNumber"in t.args.data&&"number"==typeof t.args.data.lineNumber&&(e=t.args.data.lineNumber);"columnNumber"in t.args.data&&"number"==typeof t.args.data.columnNumber&&(n=t.args.data.columnNumber);return{lineNumber:e,columnNumber:n}}(t),{lineNumber:n,columnNumber:r}=e;switch(t.name){case"FunctionCall":case"EvaluateScript":case"v8.compile":case"v8.produceCache":return{lineNumber:"number"==typeof n?n-1:void 0,columnNumber:"number"==typeof r?r-1:void 0};default:return e}},getZeroIndexedStackTraceForEvent:function(t){const e=f(t);return e?e.map((e=>{switch(t.name){case"ScheduleStyleRecalculation":case"InvalidateLayout":case"UpdateLayoutTree":return b(e);default:if(n.TraceEvents.isTraceEventUserTiming(t)||n.Extensions.isSyntheticExtensionEntry(t))return b(e)}return e})):null},makeZeroBasedCallFrame:b,frameIDForEvent:function(t){return t.args&&"beginData"in t.args&&"object"==typeof t.args.beginData&&null!==t.args.beginData&&"frame"in t.args.beginData&&"string"==typeof t.args.beginData.frame?t.args.beginData.frame:t.args?.data?.frame?t.args.data.frame:null},isTopLevelEvent:w,findUpdateLayoutTreeEvents:function(t,e,r){const i=[];for(let s=N(t,e);s<t.length;s++){const e=t[s];n.TraceEvents.isTraceEventUpdateLayoutTree(e)&&(e.ts>=(r||1/0)||i.push(e))}return i},forEachEvent:function(t,e){const r=e.startTime||n.Timing.MicroSeconds(0),i=e.endTime||n.Timing.MicroSeconds(1/0),s=!1!==e.ignoreAsyncEvents,o=[];for(let a=N(t,r);a<t.length;a++){const c=t[a],l=m(c);if(l.endTime<r)continue;if(l.startTime>i)break;if(s&&n.TraceEvents.isAsyncPhase(c.ph)||n.TraceEvents.isFlowPhase(c.ph))continue;let u=o.at(-1),d=u?m(u).endTime:null;for(;u&&d&&d<=l.startTime;)o.pop(),e.onEndEvent(u),u=o.at(-1),d=u?m(u).endTime:null;e.eventFilter&&!e.eventFilter(c)||(l.duration?(e.onStartEvent(c),o.push(c)):e.onInstantEvent&&e.onInstantEvent(c))}for(;o.length;){const t=o.pop();t&&e.onEndEvent(t)}},eventHasCategory:function(t,e){let n=x.get(t.cat);return n||(n=new Set(t.cat.split(",")||[])),n.has(e)},nodeIdForInvalidationEvent:function(t){return t.args.data.nodeId??null}});let F=0;const C=()=>++F,_=()=>({roots:new Set,maxDepth:0}),D=(t,e)=>({entry:t,id:e,parent:null,children:[],depth:0});function P(t,e){const r=new Map,i=[];F=-1;const s=_();for(let o=0;o<t.length;o++){const a=t[o];if(e&&!e.filter.has(a.name))continue;const c=a.dur||0,l=C(),u=D(a,l);if(0===i.length){s.roots.add(u),u.selfTime=n.Timing.MicroSeconds(c),i.push(u),s.maxDepth=Math.max(s.maxDepth,i.length),r.set(a,u);continue}const d=i.at(-1);if(void 0===d)throw new Error("Impossible: no parent node found in the stack");const m=d.entry,h=a.ts,f=m.ts,g=h+c,p=f+(m.dur||0);if(h<f)throw new Error("Impossible: current event starts before the parent event");if(h>=p){i.pop(),o--,F--;continue}g>p||(u.depth=i.length,u.parent=d,d.children.push(u),u.selfTime=n.Timing.MicroSeconds(c),void 0!==d.selfTime&&(d.selfTime=n.Timing.MicroSeconds(d.selfTime-(a.dur||0))),i.push(u),s.maxDepth=Math.max(s.maxDepth,i.length),r.set(a,u))}return{tree:s,entryToNode:r}}function B(t,e,r,i,s,o){if(!s||function(t,e){const n=t.entry.ts,r=t.entry.ts+(t.entry.dur||0);if(n>=e.min&&n<e.max)return!0;if(r>e.min&&r<=e.max)return!0;if(n<=e.min&&r>=e.max)return!0;return!1}(e,s)){if(void 0!==o){if(n.Timing.MicroSeconds(e.entry.ts+n.Timing.MicroSeconds(e.entry.dur||0))<o)return}r(e.entry);for(const n of e.children)B(t,n,r,i,s,o);i(e.entry)}}function R(t){const e=[];for(const n of t){const t=n.ts,r=n.ts+(n.dur||0);let i=e.at(-1);if(void 0===i){e.push(n);continue}let s=i.ts+(i.dur||0);for(;e.length&&t>=s&&(e.pop(),i=e.at(-1),void 0!==i);)s=i.ts+(i.dur||0);if(e.length&&r>s)return!1;e.push(n)}return!0}var A=Object.freeze({__proto__:null,makeTraceEntryNodeId:C,makeEmptyTraceEntryTree:_,makeEmptyTraceEntryNode:D,treify:P,walkTreeFromEntry:function(t,e,n,r){const i=t.get(e);i&&B(t,i,n,r)},walkEntireTree:function(t,e,n,r,i,s){for(const o of e.roots)B(t,o,n,r,i,s)},canBuildTreesFromEvents:R});var j=Object.freeze({__proto__:null,buildTrackDataFromExtensionEntries:function(e,n,r){const i=new Map;for(const n of e){const e=n.args.trackGroup||`track-name-${n.args.track}`,r=t.MapUtilities.getWithDefault(i,e,(()=>({name:n.args.trackGroup||n.args.track,isTrackGroup:Boolean(n.args.trackGroup),entriesByTrack:{[n.args.track]:[]}})));r.entriesByTrack[n.args.track]||(r.entriesByTrack[n.args.track]=[]);r.entriesByTrack[n.args.track].push(n)}for(const t of i.values()){for(const e of Object.values(t.entriesByTrack))if(p(e),R(e))for(const[t,n]of P(e).entryToNode)r.set(t,n);n.push(t)}return{extensionTrackData:n,entryToNode:r}}});var U=Object.freeze({__proto__:null,isSyntheticNetworkRequestEventRenderBlocking:function(t){return"non_blocking"!==t.args.data.renderBlocking}});class O{#n=[];#r=[];#i;#s;#o=[];#a=!1;#c;#l=new Map;#u;#d;jsSampleEvents=[];constructor(t,e,r,i,s){this.#c=t,this.#s=i,this.#i=r,this.#u=s||n.Configuration.defaults(),this.#d=e}buildProfileCalls(t){const e=S(t,this.callsFromProfileSamples()),r=[];for(let t=0;t<e.length;t++){const i=e[t];if("I"===i.ph)continue;if(0===r.length){if(n.TraceEvents.isProfileCall(i)){this.#m(i);continue}r.push(i),this.#h(i);continue}const s=r.at(-1);if(void 0===s)continue;i.ts>=s.ts+(s.dur||0)?(this.#f(s),r.pop(),t--):n.TraceEvents.isProfileCall(i)?this.#m(i,s):(this.#h(i),r.push(i))}for(;r.length;){const t=r.pop();t&&this.#f(t)}return this.#n}#h(t){"RunMicrotasks"!==t.name&&"RunTask"!==t.name||(this.#o=[],this.#g(0,t.ts),this.#a=!1),this.#a&&(this.#g(this.#o.pop()||0,t.ts),this.#a=!1),this.#p(t),this.#o.push(this.#r.length)}#m(t,e){if(e&&n.TraceEvents.isJSInvocationEvent(e)||this.#a)this.#p(t);else if(n.TraceEvents.isProfileCall(t)&&0===this.#r.length){this.#a=!0;const e=this.#r.length;this.#p(t),this.#o.push(e)}}#f(t){const e=n.Timing.MicroSeconds(t.ts+(t.dur||0));this.#g(this.#o.pop()||0,e)}callsFromProfileSamples(){const t=this.#c.samples,e=this.#c.timestamps,r=this.#u.debugMode;if(!t)return[];const i=[];let s;for(let o=0;o<t.length;o++){const t=this.#c.nodeByIndex(o),a=c(n.Timing.MilliSeconds(e[o]));if(!t)continue;const l=E(t,this.#d,o,a,this.#i,this.#s);i.push(l),r&&this.jsSampleEvents.push(this.#S(l,a)),t.id===this.#c.gcNode?.id&&s?this.#l.set(l,s):s=t}return i}#v(t){let e=this.#c.nodeById(t.nodeId);const n=e?.id===this.#c.gcNode?.id;if(n&&(e=this.#l.get(t)||null),!e)return[];const r=new Array(e.depth+1+Number(n));let i=r.length-1;for(n&&(r[i--]=t);e;)r[i--]=E(e,t.profileId,t.sampleIndex,t.ts,this.#i,this.#s),e=e.parent;return r}#p(t){const e=n.TraceEvents.isProfileCall(t)?this.#v(t):this.#r;O.filterStackFrames(e,this.#u);const r=t.ts+(t.dur||0),i=Math.min(e.length,this.#r.length);let s;for(s=this.#o.at(-1)||0;s<i;++s){const t=e[s].callFrame,i=this.#r[s].callFrame;if(!O.framesAreEqual(t,i))break;this.#r[s].dur=n.Timing.MicroSeconds(Math.max(this.#r[s].dur||0,r-this.#r[s].ts))}for(this.#g(s,t.ts);s<e.length;++s){const t=e[s];t.nodeId!==this.#c.programNode?.id&&t.nodeId!==this.#c.root?.id&&t.nodeId!==this.#c.idleNode?.id&&t.nodeId!==this.#c.gcNode?.id&&(this.#r.push(t),this.#n.push(t))}}#g(t,e){if(this.#o.length){const n=this.#o.at(-1);n&&t<n&&(console.error(`Child stack is shallower (${t}) than the parent stack (${n}) at ${e}`),t=n)}this.#r.length<t&&(console.error(`Trying to truncate higher than the current stack size at ${e}`),t=this.#r.length);for(let t=0;t<this.#r.length;++t)this.#r[t].dur=n.Timing.MicroSeconds(Math.max(e-this.#r[t].ts,0));this.#r.length=t}#S(t,e){return{name:"JSSample",cat:"devtools.timeline",args:{data:{stackTrace:this.#v(t).map((t=>t.callFrame))}},ph:"I",ts:e,dur:n.Timing.MicroSeconds(0),pid:this.#i,tid:this.#s}}static framesAreEqual(t,e){return t.scriptId===e.scriptId&&t.functionName===e.functionName&&t.lineNumber===e.lineNumber}static showNativeName(t,e){return e&&Boolean(O.nativeGroup(t))}static nativeGroup(t){return t.startsWith("Parse")?"Parse":t.startsWith("Compile")||t.startsWith("Recompile")?"Compile":null}static isNativeRuntimeFrame(t){return"native V8Runtime"===t.url}static filterStackFrames(t,e){if(e.showAllEvents)return;let n=null,r=0;for(let i=0;i<t.length;++i){const s=t[i].callFrame,o=O.isNativeRuntimeFrame(s);if(o&&!O.showNativeName(s.functionName,e.includeRuntimeCallStats))continue;const a=o?O.nativeGroup(s.functionName):null;n&&n===a||(n=a,t[r++]=t[i])}t.length=r}}var G=Object.freeze({__proto__:null,SamplesIntegrator:O});export{j as Extensions,U as Network,G as SamplesIntegrator,a as SyntheticEvents,h as Timing,J as Trace,A as TreeHelpers};
