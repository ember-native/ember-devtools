import*as e from"./extras/extras.js";export{e as Extras};import*as t from"./handlers/handlers.js";export{t as Handlers};import*as r from"./helpers/helpers.js";export{r as Helpers};import*as s from"./insights/insights.js";export{s as Insights};import*as n from"./lantern/lantern.js";export{n as Lantern};import*as a from"../../core/platform/platform.js";import*as i from"./types/types.js";export{i as Types};import*as o from"./root-causes/root-causes.js";export{o as RootCauses};import*as c from"../../core/sdk/sdk.js";function d(e,t,r){const s=e.PageLoadMetrics.metricScoresByFrameId.get(t);if(!s)throw new n.Core.LanternError("missing metric scores for frame");const a=s.get(r);if(!a)throw new n.Core.LanternError("missing metric scores for specified navigation");return{timestamps:{firstContentfulPaint:(e=>{const t=a.get(e);if(!t?.event)throw new n.Core.LanternError(`missing metric: ${e}`);return t.event.ts})("FCP"),largestContentfulPaint:(e=>{const t=a.get(e);if(t?.event)return t.event.ts})("LCP")}}}function l(e){return"string"==typeof e&&(e=new URL(e)),{scheme:e.protocol.split(":")[0],host:e.hostname,securityOrigin:e.origin}}function h(e,t,r){if(void 0===r.args.data.connectionId||void 0===r.args.data.connectionReused)throw new n.Core.LanternError("Trace is too old");let s;try{s=new URL(r.args.data.url)}catch(e){return}const a=r.args.data.timing?{workerFetchStart:-1,workerRespondWithSettled:-1,...r.args.data.timing}:void 0,i=a?1e3*a.requestTime:r.args.data.syntheticData.downloadStart/1e3;let o=!1;const c=t.get(r.pid);c?.includes(r.tid)&&(o=!0),e.Workers.workerIdByThread.has(r.tid)&&(o=!0);const d=r.args.data.initiator??{type:"other"};if(r.args.data.stackTrace){const e=r.args.data.stackTrace.map((e=>({scriptId:String(e.scriptId),url:e.url,lineNumber:e.lineNumber-1,columnNumber:e.columnNumber-1,functionName:e.functionName})));d.stack={callFrames:e}}let h=r.args.data.resourceType;"xmlhttprequest"===r.args.data.initiator?.fetchType?h="XHR":"fetch"===r.args.data.initiator?.fetchType&&(h="Fetch");let u=r.args.data.decodedBodyLength??0;if("data:"===s.protocol&&0===u){const e="base64,",t=s.pathname.indexOf(e);-1!==t&&(u=atob(s.pathname.substring(t+e.length)).length)}return{rawRequest:r,requestId:r.args.data.requestId,connectionId:r.args.data.connectionId,connectionReused:r.args.data.connectionReused,url:r.args.data.url,protocol:r.args.data.protocol,parsedURL:l(s),documentURL:r.args.data.requestingFrameUrl,rendererStartTime:r.ts/1e3,networkRequestTime:i,responseHeadersEndTime:r.args.data.syntheticData.downloadStart/1e3,networkEndTime:r.args.data.syntheticData.finishTime/1e3,transferSize:r.args.data.encodedDataLength,resourceSize:u,fromDiskCache:r.args.data.syntheticData.isDiskCached,fromMemoryCache:r.args.data.syntheticData.isMemoryCached,isLinkPreload:r.args.data.isLinkPreload,finished:r.args.data.finished,failed:r.args.data.failed,statusCode:r.args.data.statusCode,initiator:d,timing:a,resourceType:h,mimeType:r.args.data.mimeType,priority:r.args.data.priority,frameId:r.args.data.frame,fromWorker:o,redirects:void 0,redirectSource:void 0,redirectDestination:void 0,initiatorRequest:void 0}}function u(e,t){if(e.redirectSource)return e.redirectSource;const r=n.Graph.PageDependencyGraph.getNetworkInitiators(e)[0];let s=t.get(r)||[];if(s=s.filter((t=>t.responseHeadersEndTime<=e.rendererStartTime&&t.finished&&!t.failed)),s.length>1){const e=s.filter((e=>e.resourceType!==n.Types.NetworkRequestTypes.Other));e.length&&(s=e)}if(s.length>1){const t=s.filter((t=>t.frameId===e.frameId));t.length&&(s=t)}if(s.length>1&&"parser"===e.initiator.type){const e=s.filter((e=>e.resourceType===n.Types.NetworkRequestTypes.Document));e.length&&(s=e)}if(s.length>1){const e=s.filter((e=>e.isLinkPreload));if(e.length){const t=s.filter((e=>!e.isLinkPreload)),r=t.every((e=>e.fromDiskCache||e.fromMemoryCache));t.length&&r&&(s=e)}}return 1===s.length?s[0]:null}function g(e,t,r=0,s=Number.POSITIVE_INFINITY){const n=function(e){const t=new Map,r=["ServiceWorker thread","DedicatedWorker thread"];for(const s of e.traceEvents){if("thread_name"!==s.name||!s.args.name)continue;if(!r.includes(s.args.name))continue;const e=t.get(s.pid);e?e.push(s.tid):t.set(s.pid,[s.tid])}return t}(e),a=[];for(const e of t.NetworkRequests.byTime)if(e.ts>=r&&e.ts<s){const r=h(t,n,e);r&&a.push(r)}for(const e of[...a]){if(!e.rawRequest)continue;const t=e.rawRequest.args.data.redirects;if(!t.length)continue;const r=[];for(const s of t){const t=structuredClone(e);t.networkRequestTime=s.ts/1e3,t.rendererStartTime=t.networkRequestTime,t.networkEndTime=(s.ts+s.dur)/1e3,t.responseHeadersEndTime=t.networkEndTime,t.timing={requestTime:t.networkRequestTime/1e3,receiveHeadersStart:t.responseHeadersEndTime,receiveHeadersEnd:t.responseHeadersEndTime,proxyStart:-1,proxyEnd:-1,dnsStart:-1,dnsEnd:-1,connectStart:-1,connectEnd:-1,sslStart:-1,sslEnd:-1,sendStart:-1,sendEnd:-1,workerStart:-1,workerReady:-1,workerFetchStart:-1,workerRespondWithSettled:-1,pushStart:-1,pushEnd:-1},t.url=s.url,t.parsedURL=l(s.url),t.statusCode=302,t.resourceType=void 0,t.transferSize=400,r.push(t),a.push(t)}r.push(e);for(let e=0;e<r.length;e++){const t=r[e];e>0&&(t.redirectSource=r[e-1],t.redirects=r.slice(0,e)),e!==r.length-1&&(t.redirectDestination=r[e+1])}for(let e=1;e<r.length;e++)r[e].requestId=`${r[e-1].requestId}:redirect`}return function(e){const t=new Map;for(const r of e){const e=t.get(r.url)||[];e.push(r),t.set(r.url,e)}for(const r of e){const e=u(r,t);e&&(r.initiatorRequest=e)}}(a),a.sort(((e,t)=>e.rendererStartTime-t.rendererStartTime))}function f(e,t,r,s){const a=function(e,t){const r=t.Meta,s=r.mainFrameNavigations.length?new Set(r.mainFrameNavigations.map((e=>e.pid))):r.topLevelRendererIds,n=new Map;for(const e of s){const t=r.threadsInProcess.get(e)??[];let s=!1;for(const[r,a]of t)if("CrRendererMain"===a.args.name){n.set(e,r),s=!0;break}if(!s)for(const[r,a]of t)if("CrBrowserMain"===a.args.name){n.set(e,r),s=!0;break}}return e.traceEvents.filter((e=>n.get(e.pid)===e.tid))}(t,r);if(!s){s={requestedUrl:e[0].url,mainDocumentUrl:""};let t=e[0];for(;t.redirectDestination;)t=t.redirectDestination;s.mainDocumentUrl=t.url}return n.Graph.PageDependencyGraph.createGraph(a,e,s)}var m=Object.freeze({__proto__:null,createProcessedNavigation:d,createNetworkRequests:g,createGraph:f});class p extends Event{data;static eventName="traceparseprogress";constructor(e,t={bubbles:!0}){super(p.eventName,t),this.data=e}}class v extends EventTarget{#e;#t="IDLE";#r=i.Configuration.defaults();#s=null;#n=null;static createWithAllHandlers(){return new v(t.ModelHandlers,i.Configuration.defaults())}static getEnabledInsightRunners(e){const t={};for(const[r,n]of Object.entries(s.InsightRunners)){n.deps().some((t=>!e[t]))||Object.assign(t,{[r]:n})}return t}constructor(e,r){super(),this.#a(e),this.#e={Meta:t.ModelHandlers.Meta,...e},r&&(this.#r=r),this.#i()}#i(){for(const e of Object.values(this.#e))"handleUserConfig"in e&&e.handleUserConfig&&e.handleUserConfig(this.#r)}#a(e){if(Object.keys(e).length===Object.keys(t.ModelHandlers).length)return;const r=new Set;for(const[t,s]of Object.entries(e)){r.add(t);const e="deps"in s?s.deps():[];for(const t of e)r.add(t)}const s=new Set(Object.keys(e));r.delete("Meta");for(const e of r)if(!s.has(e))throw new Error(`Required handler ${e} not provided.`)}reset(){if("PARSING"===this.#t)throw new Error("Trace processor can't reset while parsing.");const e=Object.values(this.#e);for(const t of e)t.reset();this.#s=null,this.#n=null,this.#t="IDLE"}async parse(e,t=!1){if("IDLE"!==this.#t)throw new Error(`Trace processor can't start parsing when not idle. Current state: ${this.#t}`);try{this.#t="PARSING",await this.#o(e,t),this.#s&&this.#c(this.#s,e),this.#t="FINISHED_PARSING"}catch(e){throw this.#t="ERRORED_WHILE_PARSING",e}}async#o(e,t){const r=[...w(this.#e).values()];for(const e of r)e.reset();for(const e of r)e.initialize?.(t);for(let t=0;t<e.length;++t){t%5e4==0&&t&&(this.dispatchEvent(new p({index:t,total:e.length})),await new Promise((e=>setTimeout(e,0))));const s=e[t];for(let e=0;e<r.length;++e)r[e].handleEvent(s)}for(const e of r)e.finalize&&(await new Promise((e=>setTimeout(e,0))),await e.finalize());const s=(e,t=!0)=>{if(e instanceof Map)return new Map(e);if(e instanceof Set)return new Set(e);if(Array.isArray(e))return[...e];if("object"==typeof e&&e&&t){const t={};for(const[r,n]of Object.entries(e))t[r]=s(n,!1);return t}return e},n={};for(const[e,t]of Object.entries(this.#e)){const r=s(t.data());Object.assign(n,{[e]:r})}this.#s=n}get traceParsedData(){return"FINISHED_PARSING"!==this.#t?null:this.#s}get insights(){return"FINISHED_PARSING"!==this.#t?null:this.#n}#d(e,t,r,s){if(!e.NetworkRequests||!e.Workers||!e.PageLoadMetrics)return;if(!e.NetworkRequests.byTime.length)throw new n.Core.LanternError("No network requests found in trace");const a=e.Meta.navigationsByFrameId.get(r),i=a?.findIndex((e=>e.args.data?.navigationId===s));if(!a||void 0===i||-1===i)throw new n.Core.LanternError("Could not find navigation start");const o=a[i].ts,c=i+1<a.length?a[i+1].ts:Number.POSITIVE_INFINITY,l={traceEvents:t.filter((e=>e.ts>=o&&e.ts<c))},h=g(l,e,o,c),u=f(h,l,e),m=d(e,r,s),p=n.Core.NetworkAnalyzer.analyze(h),v=n.Simulation.Simulator.createSimulator({networkAnalysis:p,throttlingMethod:"simulate"}),w={graph:u,simulator:v,processedNavigation:m},y=n.Metrics.FirstContentfulPaint.compute(w),T=n.Metrics.LargestContentfulPaint.compute(w,{fcpResult:y}),E=n.Metrics.Interactive.compute(w,{lcpResult:T});return{graph:u,simulator:v,metrics:{firstContentfulPaint:y,interactive:E,largestContentfulPaint:T,totalBlockingTime:n.Metrics.TotalBlockingTime.compute(w,{fcpResult:y,interactiveResult:E})}}}#c(e,t){this.#n=new Map;const r=v.getEnabledInsightRunners(e);for(const s of e.Meta.mainFrameNavigations){const a=s.args.frame,i=s.args.data?.navigationId;if(!a||!i)continue;let o;try{o=this.#d(e,t,a,i)}catch(e){const t=["mainDocumentRequest not found","missing metric scores for main frame","missing metric: FCP","missing metric: LCP","No network requests found in trace","Trace is too old"];e instanceof n.Core.LanternError?t.some((t=>e.message===t))||console.error(e.message):console.error(e)}const c={frameId:a,navigationId:i,lantern:o},d={};for(const[t,s]of Object.entries(r)){let r;try{r=s.generateInsight(e,c)}catch(e){r=e}Object.assign(d,{[t]:r})}this.#n.set(c.navigationId,d)}}}function w(e){const t=new Map,r=new Set,s=n=>{if(t.has(n))return;if(r.has(n)){let e="";for(const t of r)(e||t===n)&&(e+=`${t}->`);throw e+=n,new Error(`Found dependency cycle in trace event handlers: ${e}`)}r.add(n);const a=e[n];if(!a)return;const i=a.deps?.();i&&i.forEach(s),t.set(n,a)};for(const t of Object.keys(e))s(t);return t}var y=Object.freeze({__proto__:null,TraceParseProgressEvent:p,TraceProcessor:v,sortHandlers:w});class T extends EventTarget{#l=[];#h=[];#u=new Map;#g=[];#f=0;#m;#p=i.Configuration.defaults();static createWithAllHandlers(e){return new T(t.ModelHandlers,e)}static createWithSubsetOfHandlers(e,t){return new T(e,t)}constructor(e,t){super(),t&&(this.#p=t),this.#m=new v(e,this.#p)}async parse(e,t){const s=t?.metadata||{},n=t?.isFreshRecording||!1,a=e=>{const{data:t}=e;this.dispatchEvent(new E({type:"PROGRESS_UPDATE",data:t}))};this.#m.addEventListener(p.eventName,a);const i={traceEvents:e,metadata:s,traceParsedData:null,traceInsights:null};try{const t=r.SyntheticEvents.SyntheticEventsManager.initAndActivate(e);await this.#m.parse(e,n),this.#v(i,this.#m.traceParsedData,this.#m.insights),this.#l.push(i),this.#h.push(t)}catch(e){throw e}finally{this.#m.removeEventListener(p.eventName,a),this.dispatchEvent(new E({type:"COMPLETE",data:"done"}))}}#v(e,t,s){e.traceParsedData=t,e.traceInsights=s,this.#f++;let n=`Trace ${this.#f}`,i=null;if(e.traceParsedData&&(i=r.Trace.extractOriginFromTrace(e.traceParsedData.Meta.mainFrameURL),i)){const e=a.MapUtilities.getWithDefault(this.#u,i,(()=>1));n=`${i} (${e})`,this.#u.set(i,e+1)}this.#g.push(n)}lastTraceIndex(){return this.size()-1}traceParsedData(e=this.#l.length-1){return this.#l[e]?this.#l[e].traceParsedData:null}traceInsights(e=this.#l.length-1){return this.#l[e]?this.#l[e].traceInsights:null}metadata(e=this.#l.length-1){return this.#l[e]?this.#l[e].metadata:null}overrideModifications(e,t){this.#l[e]&&(this.#l[e].metadata.modifications=t)}rawTraceEvents(e=this.#l.length-1){return this.#l[e]?this.#l[e].traceEvents:null}syntheticTraceEventsManager(e=this.#l.length-1){return this.#h[e]?this.#h[e]:null}size(){return this.#l.length}deleteTraceByIndex(e){this.#l.splice(e,1),this.#g.splice(e,1)}getRecordingsAvailable(){return this.#g}resetProcessor(){this.#m.reset()}}class E extends Event{data;static eventName="modelupdate";constructor(e){super(E.eventName),this.data=e}}var C=Object.freeze({__proto__:null,Model:T,ModelUpdateEvent:E,isModelUpdateDataComplete:function(e){return"COMPLETE"===e.type},isModelUpdateDataProgress:function(e){return"PROGRESS_UPDATE"===e.type}});class R extends c.SDKModel.SDKModel{#w;#y;#T;#E;#C;constructor(e){super(e),this.#w=e.tracingAgent(),e.registerTracingDispatcher(new S(this)),this.#y=null,this.#T=0,this.#E=0}bufferUsage(e,t,r){this.#T=void 0===t?null:t,this.#y&&this.#y.tracingBufferUsage(e||r||0)}eventsCollected(e){this.#y&&(this.#y.traceEventsCollected(e),this.#E+=e.length,this.#T?(this.#E>this.#T&&(this.#E=this.#T),this.#y.eventsRetrievalProgress(this.#E/this.#T)):this.#y.eventsRetrievalProgress(0))}tracingComplete(){this.#T=0,this.#E=0,this.#y&&(this.#y.tracingComplete(),this.#y=null),this.#C=!1}async reset(){this.#y&&await this.#w.invoke_end(),this.#T=0,this.#E=0,this.#y=null,this.#C=!1}async start(e,t,r){if(this.#y)throw new Error("Tracing is already started");this.#y=e;const s={bufferUsageReportingInterval:500,categories:t,options:r,transferMode:"ReportEvents"},n=await this.#w.invoke_start(s);return n.getError()&&(this.#y=null),n}stop(){if(!this.#y)throw new Error("Tracing is not started");if(this.#C)throw new Error("Tracing is already being stopped");this.#C=!0,this.#w.invoke_end()}}class S{#R;constructor(e){this.#R=e}bufferUsage({value:e,eventCount:t,percentFull:r}){this.#R.bufferUsage(e,t,r)}dataCollected({value:e}){this.#R.eventsCollected(e)}tracingComplete(){this.#R.tracingComplete()}}c.SDKModel.SDKModel.register(R,{capabilities:128,autostart:!1});var I=Object.freeze({__proto__:null,TracingManager:R});export{m as LanternComputationData,y as Processor,C as TraceModel,I as TracingManager};
