import*as t from"../../../core/platform/platform.js";import*as e from"../helpers/helpers.js";import*as n from"../types/types.js";import"../handlers/handlers.js";const r=[{flag:8192,failure:"UNSUPPORTED_CSS_PROPERTY"},{flag:2048,failure:"TRANSFROM_BOX_SIZE_DEPENDENT"},{flag:4096,failure:"FILTER_MAY_MOVE_PIXELS"},{flag:16,failure:"NON_REPLACE_COMPOSITE_MODE"},{flag:64,failure:"INCOMPATIBLE_ANIMATIONS"},{flag:8,failure:"UNSUPPORTED_TIMING_PARAMS"}],i=e.Timing.secondsToMicroseconds(n.Timing.Seconds(.5));function a(t,e){const n=t.dur?t.ts+t.dur:t.ts;return n<e.ts&&n>=e.ts-i}function o(e,n){const r=t.ArrayUtilities.nearestIndexFromBeginning(e,(t=>t.ts>n.ts+(n.dur||0)));if(null!==r)return e[r]}var s=Object.freeze({__proto__:null,deps:function(){return["Meta","Animations","LayoutShifts","NetworkRequests"]},generateInsight:function(n,i){const s=t=>{const r=e.Trace.getNavigationForTraceEvent(t,i.frameId,n.Meta.navigationsByFrameId);return r?.args.data?.navigationId===i.navigationId},c=function(t){const e=[];for(const n of t){const t=n.args.data.beginEvent,i=n.args.data.instantEvents||[];for(const n of i){const i=n.args.data.compositeFailed,a=n.args.data.unsupportedProperties;if(!i||!a)continue;const o=r.filter((t=>i&t.flag)).map((t=>t.failure)),s={name:t.args.data.displayName,failureReasons:o,unsupportedProperties:a};e.push(s)}}return e}(n.Animations.animations.filter(s)),d=n.LayoutShifts.renderFrameImplCreateChildFrameEvents.filter(s),g=n.NetworkRequests.byTime.filter(s),u=n.LayoutShifts.clusters.flatMap((t=>s(t.events[0])?t.events:[])),f=n.LayoutShifts.prePaintEvents.filter(s),l=new Map,m=function(e,n){const r=new Map;for(const i of n){const n=t.ArrayUtilities.nearestIndexFromBeginning(e,(t=>t.ts>=i.ts));if(null!==n)for(let a=n;a<e.length;a++){const n=e[a];if(n.ts>=i.ts&&n.ts<=i.ts+i.dur&&t.MapUtilities.getWithDefault(r,i,(()=>[])).push(n),n.ts>i.ts+i.dur)break}}return r}(u,f);for(const t of u)l.set(t,{iframes:[],fontRequests:[]});return function(e,n,r,i){for(const a of e){const e=o(n,a);if(!e)continue;const s=r.get(e);if(s)for(const e of s)t.MapUtilities.getWithDefault(i,e,(()=>({iframes:[],fontRequests:[]}))).iframes.push(a)}}(d,f,m,l),function(e,n,r,i){const s=e.filter((t=>"Font"===t.args.data.resourceType&&t.args.data.mimeType.startsWith("font")));for(const e of s){const s=o(n,e);if(!s)continue;if(!a(e,s))continue;const c=r.get(s);if(c)for(const n of c)t.MapUtilities.getWithDefault(i,n,(()=>({iframes:[],fontRequests:[]}))).fontRequests.push(e)}}(g,f,m,l),{animationFailures:c,shifts:l}}});var c=Object.freeze({__proto__:null,deps:function(){return["Meta","NetworkRequests"]},generateInsight:function(t,e){const r=t.NetworkRequests.byTime.find((t=>t.args.data.requestId===e.navigationId));if(!r)throw new Error("missing document request");const i=function(t){const e=t.args.data.timing;return e?n.Timing.MilliSeconds(Math.round(e.receiveHeadersStart-e.sendEnd)):null}(r);if(null===i)throw new Error("missing document request timing");let a=0;i>600&&(a=Math.max(i-100,0));const o=Math.round(r.args.data.syntheticData.redirectionDuration/1e3);a+=o;const s={FCP:a,LCP:a};return{serverResponseTime:i,redirectDuration:n.Timing.MilliSeconds(o),metricSavings:s}}});var d,g=Object.freeze({__proto__:null,deps:function(){return["UserInteractions"]},generateInsight:function(t,e){const n=t.UserInteractions.interactionEvents.filter((t=>t.args.data.navigationId===e.navigationId));if(!n.length)return{};const r=new Map;for(const t of n){const e=t.interactionId,n=r.get(e);(!n||t.dur>n.dur)&&r.set(e,t)}const i=[...r.values()];i.sort(((t,e)=>e.dur-t.dur));const a=Math.min(9,Math.floor(i.length/50));return{longestInteractionEvent:i[0],highPercentileInteractionEvent:i[a]}}});function u(t,n,r){const i=r.args.data?.nodeId;if(!i)throw new Error("no lcp node id");const a=t.LargestImagePaint.get(i);if(!a)return null;const o=a.args.data?.imageUrl;if(!o)throw new Error("no lcp url");const s=function(t,n,r){return t.NetworkRequests.byTime.find((i=>{if(i.args.data.url!==r&&!i.args.data.redirects.some((t=>t.url===r)))return!1;const a=e.Trace.getNavigationForTraceEvent(i,n.frameId,t.Meta.navigationsByFrameId);return a?.args.data?.navigationId===n.navigationId}))??null}(t,n,o);if(!s)throw new Error("no lcp request found");return s}!function(t){t.NO_FP="NO_FP",t.NO_LCP="NO_LCP",t.NO_DOCUMENT_REQUEST="NO_DOCUMENT_REQUEST",t.NO_LAYOUT="NO_LAYOUT"}(d||(d={}));var f=Object.freeze({__proto__:null,get InsightWarning(){return d}});function l(t,r,i,a){const o=r.args.data.timing;if(!o)throw new Error("no timing for main resource");const s=e.Timing.secondsToMicroseconds(o.requestTime)+e.Timing.millisecondsToMicroseconds(o.receiveHeadersStart),c=n.Timing.MicroSeconds(s-t.ts),d=e.Timing.microSecondsToMilliseconds(c);let g=n.Timing.MilliSeconds(i-d);if(!a)return{ttfb:d,renderDelay:g};const u=n.Timing.MicroSeconds(a.ts-t.ts),f=e.Timing.microSecondsToMilliseconds(u),l=n.Timing.MicroSeconds(a.args.data.syntheticData.finishTime-t.ts),m=e.Timing.microSecondsToMilliseconds(l),T=n.Timing.MilliSeconds(f-d),p=n.Timing.MilliSeconds(m-f);return g=n.Timing.MilliSeconds(i-m),{ttfb:d,loadDelay:T,loadTime:p,renderDelay:g}}var m=Object.freeze({__proto__:null,deps:function(){return["NetworkRequests","PageLoadMetrics","LargestImagePaint","Meta"]},generateInsight:function(t,r){const i=t.NetworkRequests,a=t.Meta.navigationsByNavigationId.get(r.navigationId);if(!a)throw new Error("no trace navigation");const o=t.PageLoadMetrics.metricScoresByFrameId.get(r.frameId);if(!o)throw new Error("no frame metrics");const s=o.get(r.navigationId);if(!s)throw new Error("no navigation metrics");const c=s.get("LCP"),g=c?.event;if(!g||!n.TraceEvents.isTraceEventLargestContentfulPaintCandidate(g))return{warnings:[d.NO_LCP]};const f=e.Timing.microSecondsToMilliseconds(c.timing),m=c.event?.ts?e.Timing.microSecondsToMilliseconds(c.event?.ts):void 0,T=u(t,r,g),p=i.byTime.find((t=>t.args.data.requestId===r.navigationId));if(!p)return{lcpMs:f,lcpTs:m,warnings:[d.NO_DOCUMENT_REQUEST]};if(!T)return{lcpMs:f,lcpTs:m,phases:l(a,p,f,T)};const I=g.args.data?.loadingAttr,v=T?.args.data.isLinkPreload||"preload"===T?.args.data.initiator?.type,h=T?.args.data.fetchPriorityHint,M=p&&p.args.data.timing?e.Timing.secondsToMicroseconds(p.args.data.timing.requestTime)+e.Timing.millisecondsToMicroseconds(p.args.data.timing.receiveHeadersStart):void 0;return{lcpMs:f,lcpTs:m,phases:l(a,p,f,T),shouldRemoveLazyLoading:"lazy"===I,shouldIncreasePriorityHint:"high"!==h,shouldPreloadImage:!v,lcpResource:T,earliestDiscoveryTimeTs:M?n.Timing.MicroSeconds(M):void 0}}});const T=50;function p(t,e,r){if(!e.lantern)return;const i=function(t){const e=new Map;for(const[n,r]of t)"network"===n.type&&e.set(n.request.requestId,{node:n,nodeTiming:r});return e}(e.lantern.metrics.firstContentfulPaint.optimisticEstimate.nodeTimings),a={FCP:0,LCP:0},o=new Map,s=new Set;for(const t of r){const e=i.get(t.args.data.requestId);if(!e)continue;const{node:n,nodeTiming:r}=e;n.traverse((t=>s.add(t.id)));const a=Math.round(r.duration);a<T||o.set(n.id,a)}return o.size&&(a.FCP=function(t,e){const n=e.simulator,r=e.metrics.firstContentfulPaint.optimisticGraph,{nodeTimings:i}=e.simulator.simulate(r),a=new Map(i),o=r.cloneWithRelationships((e=>!t.has(e.id)));if("network"!==o.type)throw new Error("minimalFCPGraph not a NetworkNode");const s=Math.max(...Array.from(Array.from(a).map((t=>t[1].endTime)))),c=o.request.transferSize,d=c||0;o.request.transferSize=d+0;const g=n.simulate(o).timeInMs;return o.request.transferSize=c,Math.round(Math.max(s-g,0))}(s,e.lantern),function(t,e){if(!t.Meta.navigationsByNavigationId.get(e.navigationId))throw new Error("no trace navigation");const r=t.PageLoadMetrics.metricScoresByFrameId.get(e.frameId);if(!r)throw new Error("no frame metrics");const i=r.get(e.navigationId);if(!i)throw new Error("no navigation metrics");const a=i.get("LCP"),o=a?.event;return!(!o||!n.TraceEvents.isTraceEventLargestContentfulPaintCandidate(o))&&null!==u(t,e,o)}(t,e)||(a.LCP=a.FCP)),{metricSavings:a,requestIdToWastedMs:o}}var I=Object.freeze({__proto__:null,deps:function(){return["NetworkRequests","PageLoadMetrics","LargestImagePaint"]},generateInsight:function(t,n){const r=t.PageLoadMetrics.metricScoresByFrameId.get(n.frameId)?.get(n.navigationId)?.get("FP")?.event?.ts;if(!r)return{renderBlockingRequests:[],warnings:[d.NO_FP]};const i=[];for(const a of t.NetworkRequests.byTime){if(a.args.data.frame!==n.frameId)continue;if("blocking"!==a.args.data.renderBlocking&&"in_body_parser_blocking"!==a.args.data.renderBlocking)continue;if(a.args.data.syntheticData.finishTime>r)continue;if("in_body_parser_blocking"===a.args.data.renderBlocking){const t=a.args.data.priority,e="Script"===a.args.data.resourceType;if("VeryHigh"!==t&&!(e&&"High"===t))continue}const o=e.Trace.getNavigationForTraceEvent(a,n.frameId,t.Meta.navigationsByFrameId);o?.args.data?.navigationId===n.navigationId&&i.push(a)}return{renderBlockingRequests:i,...p(t,n,i)}}});var v=Object.freeze({__proto__:null,deps:function(){return["Meta","UserInteractions"]},generateInsight:function(t,n){const r=t.UserInteractions.beginCommitCompositorFrameEvents.filter((r=>{if(r.args.frame!==n.frameId)return!1;const i=e.Trace.getNavigationForTraceEvent(r,n.frameId,t.Meta.navigationsByFrameId);return i?.args.data?.navigationId===n.navigationId}));if(!r.length)return{mobileOptimized:null,warnings:[d.NO_LAYOUT]};const i=t.UserInteractions.parseMetaViewportEvents.find((r=>{if(r.args.data.frame!==n.frameId)return!1;const i=e.Trace.getNavigationForTraceEvent(r,n.frameId,t.Meta.navigationsByFrameId);return i?.args.data?.navigationId===n.navigationId})),a=i?.args.data.content,o=i?.args.data.node_id;for(const t of r)if(!t.args.is_mobile_optimized)return{mobileOptimized:!1,content:a,nodeId:o};return{mobileOptimized:!0,content:a,nodeId:o}}}),h=Object.freeze({__proto__:null,CumulativeLayoutShift:s,DocumentLatency:c,InteractionToNextPaint:g,LargestContentfulPaint:m,RenderBlocking:I,Viewport:v});export{h as InsightRunners,f as Types};
